name: CI Pipeline

on:
  pull_request:
    branches: [ main, develop, release ]
  workflow_dispatch:

jobs:
  # Linting Checks
  linting-account-service:
    name: Linting - Account Service
    runs-on: self-hosted
    env:
      PYTHONPATH: ${{ github.workspace }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-qa.txt
          pip install -r account-service/requirements.txt

      - name: Run flake8
        working-directory: ./account-service
        run: |
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run black check
        working-directory: ./account-service
        run: |
          black --check app/

      - name: Run pylint
        working-directory: ./account-service
        run: |
          pylint app/ --max-line-length=127 --disable=C0111,C0103

  linting-transaction-service:
    name: Linting - Transaction Service
    runs-on: self-hosted
    env:
      PYTHONPATH: ${{ github.workspace }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-qa.txt
          pip install -r transaction-service/requirements.txt

      - name: Run flake8
        working-directory: ./transaction-service
        run: |
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run black check
        working-directory: ./transaction-service
        run: |
          black --check app/

      - name: Run pylint
        working-directory: ./transaction-service
        run: |
          pylint app/ --max-line-length=127 --disable=C0111,C0103

  linting-shared:
    name: Linting - Shared Module
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-qa.txt
          pip install pydantic

      - name: Run flake8
        working-directory: ./shared
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run black check
        working-directory: ./shared
        run: |
          black --check .

      - name: Run pylint
        working-directory: ./shared
        run: |
          pylint *.py --max-line-length=127 --disable=C0111,C0103

  # Unit Tests with Coverage
  unit-test-coverage-account-service:
    name: Unit Tests & Coverage - Account Service
    runs-on: self-hosted
    needs: [linting-account-service]
    env:
      PYTHONPATH: ${{ github.workspace }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-qa.txt
          pip install -r account-service/requirements.txt

      - name: Run tests with coverage for service.py (min 75%)
        working-directory: ./account-service
        run: |
          pytest --cov=app.service --cov-report=term-missing --cov-fail-under=75 tests/ -v

  unit-test-coverage-transaction-service:
    name: Unit Tests & Coverage - Transaction Service
    runs-on: self-hosted
    needs: [linting-transaction-service]
    env:
      PYTHONPATH: ${{ github.workspace }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-qa.txt
          pip install -r transaction-service/requirements.txt

      - name: Run tests with coverage for service.py (min 75%)
        working-directory: ./transaction-service
        run: |
          pytest --cov=app.service --cov-report=term-missing --cov-fail-under=75 tests/ -v

  # Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: self-hosted
    needs: [unit-test-coverage-account-service, unit-test-coverage-transaction-service]
    env:
      PYTHONPATH: ${{ github.workspace }}
      POSTGRES_USER: ${{ secrets.TEST_POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.TEST_POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-qa.txt
          pip install -r account-service/requirements.txt
          pip install -r transaction-service/requirements.txt

      - name: Run integration tests
        run: |
          set -euo pipefail
          pytest integration-tests/ -v --tb=short

