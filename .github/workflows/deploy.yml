name: Deploy Banking Services

on:
  workflow_run:
    workflows:
      - CI Pipeline
    types:
      - completed
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build Images and Deploy
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Determine image tags
        id: vars
        env:
          HEAD_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
        run: |
          TAG="$(echo "${HEAD_SHA:-${GITHUB_SHA}}" | cut -c1-12)"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "head_sha=${HEAD_SHA:-${GITHUB_SHA}}" >> "${GITHUB_OUTPUT}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push account service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: account-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/account-service:${{ steps.vars.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/account-service:latest

      - name: Build and push transaction service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: transaction-service/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/transaction-service:${{ steps.vars.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/transaction-service:latest

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Ansible and collections
        run: |
          python -m pip install --upgrade pip
          pip install "ansible-core==2.15.6"
          ansible-galaxy collection install community.docker community.general ansible.posix

      - name: Override inventory host from secrets
        env:
          TARGET_HOST: ${{ secrets.ANSIBLE_HOST }}
        run: |
          if [ -n "$TARGET_HOST" ]; then
            printf "[banking]\nbanking-prod ansible_host=%s\n" "$TARGET_HOST" > ansible/inventory/hosts.ini
          fi

      - name: Configure SSH access
        env:
          TARGET_HOST: ${{ secrets.ANSIBLE_HOST }}
          PRIVATE_KEY: ${{ secrets.ANSIBLE_PRIVATE_KEY }}
        run: |
          HOST="${TARGET_HOST:-YOUR_PRODUCTION_HOST_IP}"
          mkdir -p ~/.ssh
          printf '%s\n' "$PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts

      - name: Run Ansible deployment
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
          ANSIBLE_BECOME_PASSWORD: ${{ secrets.ANSIBLE_BECOME_PASSWORD }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          RABBITMQ_QUEUE: ${{ secrets.RABBITMQ_QUEUE }}
          RABBITMQ_PORT: ${{ secrets.RABBITMQ_PORT }}
          RABBITMQ_MANAGEMENT_PORT: ${{ secrets.RABBITMQ_MANAGEMENT_PORT }}
        run: |
          ansible-playbook \
            -i ansible/inventory/hosts.ini \
            -u "${{ secrets.ANSIBLE_USER }}" \
            --private-key ~/.ssh/id_rsa \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_password=${{ secrets.DOCKERHUB_TOKEN }}" \
            -e "image_tag=${{ steps.vars.outputs.tag }}" \
            ansible/playbooks/deploy.yml
