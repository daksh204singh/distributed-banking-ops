name: Deploy Banking Services

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      promote_canary:
        description: 'Set to "true" to promote the current canary to stable'
        required: false
        default: "false"
      canary_weight:
        description: "Traffic percentage that should route to the canary (0-100)"
        required: false
        default: "10"
      enable_canary:
        description: 'Set to "false" to deploy only the stable release'
        required: false
        default: "true"

jobs:
  build-and-deploy:
    name: Build Images and Deploy
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Determine image tags
        id: vars
        run: |
          TAG="$(echo "${GITHUB_SHA}" | cut -c1-12)"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "head_sha=${GITHUB_SHA}" >> "${GITHUB_OUTPUT}"

      - name: Set canary rollout defaults
        id: rollout_defaults
        run: |
          echo "promote=false" >> "${GITHUB_OUTPUT}"
          echo "weight=10" >> "${GITHUB_OUTPUT}"
          echo "enable=true" >> "${GITHUB_OUTPUT}"

      - name: Capture manual rollout inputs
        id: rollout_manual
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          promote="${{ inputs.promote_canary }}"
          weight="${{ inputs.canary_weight }}"
          enable="${{ inputs.enable_canary }}"
          if [ -z "$promote" ]; then promote="false"; fi
          if [ -z "$weight" ]; then weight="10"; fi
          if [ -z "$enable" ]; then enable="true"; fi
          echo "promote=$promote" >> "${GITHUB_OUTPUT}"
          echo "weight=$weight" >> "${GITHUB_OUTPUT}"
          echo "enable=$enable" >> "${GITHUB_OUTPUT}"

      - name: Merge rollout settings
        id: rollout
        run: |
          promote="${{ steps.rollout_manual.outputs.promote || steps.rollout_defaults.outputs.promote }}"
          weight="${{ steps.rollout_manual.outputs.weight || steps.rollout_defaults.outputs.weight }}"
          enable="${{ steps.rollout_manual.outputs.enable || steps.rollout_defaults.outputs.enable }}"
          echo "promote=$promote" >> "${GITHUB_OUTPUT}"
          echo "weight=$weight" >> "${GITHUB_OUTPUT}"
          echo "enable=$enable" >> "${GITHUB_OUTPUT}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push account service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: account-service/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/account-service:${{ steps.vars.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/account-service:latest

      - name: Build and push transaction service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: transaction-service/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/transaction-service:${{ steps.vars.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/transaction-service:latest

      - name: Build and push autoscale service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: autoscale-service/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/autoscale-service:${{ steps.vars.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/autoscale-service:latest

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign images with cosign
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_YES: "true"
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.tag }}"
          USER="${{ secrets.DOCKERHUB_USERNAME }}"
          printf '%s' "${COSIGN_PRIVATE_KEY}" > /tmp/cosign.key
          for IMG in account-service transaction-service autoscale-service; do
            cosign sign --key /tmp/cosign.key docker.io/${USER}/${IMG}:${TAG}
            cosign sign --key /tmp/cosign.key docker.io/${USER}/${IMG}:latest
          done
          rm -f /tmp/cosign.key

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Ansible and collections
        run: |
          python -m pip install --upgrade pip
          pip install "ansible-core==2.15.6"
          ansible-galaxy collection install community.docker community.general ansible.posix

      - name: Override inventory host from secrets
        env:
          TARGET_HOST: ${{ secrets.ANSIBLE_HOST }}
        run: |
          if [ -n "$TARGET_HOST" ]; then
            printf "[banking]\nbanking-prod ansible_host=%s\n" "$TARGET_HOST" > ansible/inventory/hosts.ini
          fi

      - name: Configure SSH access
        env:
          TARGET_HOST: ${{ secrets.ANSIBLE_HOST }}
          PRIVATE_KEY: ${{ secrets.ANSIBLE_PRIVATE_KEY }}
        run: |
          HOST="${TARGET_HOST:-YOUR_PRODUCTION_HOST_IP}"
          mkdir -p ~/.ssh
          printf '%s\n' "$PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts

      - name: Prepare cosign vars for Ansible
        env:
          COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}
        run: |
          {
            echo "cosign_enable_verify: true"
            echo "cosign_install_binary: true"
            echo "cosign_public_key_content: |"
            printf '%s\n' "$COSIGN_PUBLIC_KEY" | sed 's/^/  /'
          } > /tmp/cosign-vars.yml

      - name: Run Ansible deployment
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
          ANSIBLE_BECOME_PASSWORD: ${{ secrets.ANSIBLE_BECOME_PASSWORD }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          RABBITMQ_QUEUE: ${{ secrets.RABBITMQ_QUEUE }}
          RABBITMQ_PORT: ${{ secrets.RABBITMQ_PORT }}
          RABBITMQ_MANAGEMENT_PORT: ${{ secrets.RABBITMQ_MANAGEMENT_PORT }}
        run: |
          ansible-playbook \
            -i ansible/inventory/hosts.ini \
            -u "${{ secrets.ANSIBLE_USER }}" \
            --private-key ~/.ssh/id_rsa \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_password=${{ secrets.DOCKERHUB_TOKEN }}" \
            -e "account_service_image_repo=${{ secrets.DOCKERHUB_USERNAME }}/account-service" \
          -e "transaction_service_image_repo=${{ secrets.DOCKERHUB_USERNAME }}/transaction-service" \
            -e "autoscale_service_image_repo=${{ secrets.DOCKERHUB_USERNAME }}/autoscale-service" \
            -e "canary_tag=${{ steps.vars.outputs.tag }}" \
            -e "canary_traffic_percentage=${{ steps.rollout.outputs.weight }}" \
            -e "promote_canary=${{ steps.rollout.outputs.promote }}" \
            -e "enable_canary=${{ steps.rollout.outputs.enable }}" \
            -e "@/tmp/cosign-vars.yml" \
            ansible/playbooks/deploy.yml
