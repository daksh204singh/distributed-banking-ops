upstream account_service {
    server {{ banking_account_stable_name }}:{{ banking_account_container_port }}{% if (_gateway_stable_weight | int) > 0 %} weight={{ _gateway_stable_weight }}{% endif %};
    {% if _gateway_canary_enabled and (_gateway_canary_weight | int) > 0 %}
    server {{ banking_account_canary_name }}:{{ banking_account_container_port }} weight={{ _gateway_canary_weight }};
    {% endif %}
}

upstream transaction_service {
    server {{ banking_transaction_stable_name }}:{{ banking_transaction_container_port }}{% if (_gateway_stable_weight | int) > 0 %} weight={{ _gateway_stable_weight }}{% endif %};
    {% if _gateway_canary_enabled and (_gateway_canary_weight | int) > 0 %}
    server {{ banking_transaction_canary_name }}:{{ banking_transaction_container_port }} weight={{ _gateway_canary_weight }};
    {% endif %}
}

server {
    listen {{ nginx_container_port }};

    location /account/ {
        proxy_pass http://account_service/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /transaction/ {
        proxy_pass http://transaction_service/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /healthz {
        return 200 '{"status":"ok"}';
        add_header Content-Type application/json;
    }
}
