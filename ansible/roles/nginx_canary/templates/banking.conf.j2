# Docker's internal DNS resolver for dynamic resolution
resolver 127.0.0.11 valid=1s ipv6=off;

upstream account_service {
    zone account_service 64k;  # Shared memory zone required for resolve
    least_conn;  # Use least connections algorithm for load balancing
    # Use network alias for stable traffic (supports autoscaling - resolves to all instances)
    server account-service:{{ banking_account_container_port }} resolve{% if (_gateway_stable_weight | int) > 0 %} weight={{ _gateway_stable_weight }}{% endif %};
    {% if _gateway_canary_enabled and (_gateway_canary_weight | int) > 0 %}
    # Explicit canary container reference (not using alias to keep canary separate)
    server {{ banking_account_canary_name }}:{{ banking_account_container_port }} weight={{ _gateway_canary_weight }};
    {% endif %}
    keepalive 32;  # Connection pool for better performance
}

upstream transaction_service {
    zone transaction_service 64k;  # Shared memory zone required for resolve
    least_conn;  # Use least connections algorithm for load balancing
    # Use network alias for stable traffic (supports autoscaling - resolves to all instances)
    server transaction-service:{{ banking_transaction_container_port }} resolve{% if (_gateway_stable_weight | int) > 0 %} weight={{ _gateway_stable_weight }}{% endif %};
    {% if _gateway_canary_enabled and (_gateway_canary_weight | int) > 0 %}
    # Explicit canary container reference (not using alias to keep canary separate)
    server {{ banking_transaction_canary_name }}:{{ banking_transaction_container_port }} weight={{ _gateway_canary_weight }};
    {% endif %}
    keepalive 32;  # Connection pool for better performance
}

server {
    listen {{ nginx_container_port }};

    location /account/ {
        proxy_pass http://account_service/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    location /transaction/ {
        proxy_pass http://transaction_service/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    location /healthz {
        return 200 '{"status":"ok"}';
        add_header Content-Type application/json;
    }
}
