# NGINX configuration for load balancing scaled containers
# Using upstream blocks with dynamic DNS resolution for rapid updates

# Docker's internal DNS resolver (127.0.0.11 is Docker's DNS server)
# valid=1s means DNS results are cached for only 1 second for rapid updates
resolver 127.0.0.11 valid=1s ipv6=off;

# Upstream blocks for load balancing with dynamic DNS resolution
# zone directive creates shared memory for dynamic resolution
# Using network aliases (account-service, transaction-service) so Docker DNS resolves to all instances
upstream account_service {
    zone account_service 64k;  # Shared memory zone required for resolve
    least_conn;  # Use least connections algorithm for load balancing
    server account-service:8000 resolve;  # resolve enables dynamic DNS resolution
    keepalive 32;  # Connection pool for better performance
}

upstream transaction_service {
    zone transaction_service 64k;  # Shared memory zone required for resolve
    least_conn;  # Use least connections algorithm for load balancing
    server transaction-service:8001 resolve;  # resolve enables dynamic DNS resolution
    keepalive 32;  # Connection pool for better performance
}

server {
    listen 80;
    server_name _;

    # Health check endpoint
    location /healthz {
        return 200 '{"status":"ok"}';
        add_header Content-Type application/json;
    }

    # Account service routes
    location /account/ {
        # Strip /account prefix and pass remaining path
        rewrite ^/account/(.*) /$1 break;
        proxy_pass http://account_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # Transaction service routes
    location /transaction/ {
        # Strip /transaction prefix and pass remaining path
        rewrite ^/transaction/(.*) /$1 break;
        proxy_pass http://transaction_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }

    # Metrics endpoints (pass through to services)
    location ~ ^/account(s)?/metrics$ {
        proxy_pass http://account_service$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
    
    location ~ ^/transaction(s)?/metrics$ {
        proxy_pass http://transaction_service$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}

